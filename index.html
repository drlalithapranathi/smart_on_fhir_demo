<!DOCTYPE html>
<html>
<head>
  <title>SMART App Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
</head>
<body>
  <h1>Hello from SMART on FHIR!</h1>
  <div id="output">Loading...</div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");
    const state = urlParams.get("state");

    if (!code) {
      document.getElementById("output").innerText = "No auth code found in URL.";
    } else {
      // TEMP: Use manually retrieved token (replace this with dynamic exchange later)
      const access_token = "YOUR_ACCESS_TOKEN_HERE"; // ← replace with your real token

      fetch("https://oemr.b691.us/apis/fhir/Patient", {
        headers: {
          "Authorization": "Bearer " + access_token,
          "Accept": "application/fhir+json"
        }
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        console.log("FHIR Response:", data);

        if (data.entry && data.entry.length > 0) {
          const patient = data.entry[0].resource;
          const name = patient.name?.[0];
          if (name) {
            const fullName = `${name.given.join(" ")} ${name.family}`;
            document.getElementById("output").innerText = `Patient: ${fullName}`;
          } else {
            document.getElementById("output").innerText = "Patient has no name listed.";
          }
        } else {
          document.getElementById("output").innerText = "No patient entries found.";
        }
      })
      .catch(error => {
        console.error("Error:", error);
        document.getElementById("output").innerText = "Error: " + error.message;
      });
    }
  </script>
</body>
</html>

